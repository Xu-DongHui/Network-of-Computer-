第三章：数据链路层
研究数据链路层时，只关心协议栈中水平方向的各数据链路层。
3.1基本概念
（1）链路：从一个结点到相邻结点的一段物理线路。
（2）数据链路：当在线路上传输数据时，处理物理线路外，还需要必要的通信协议，因此实现这些协议的硬件（网络适配器）和软件加到链路上就是数据链路。
（3）帧：数据链路层把网络层交下来的数据构成帧发送到链路上，并接收到帧中的数据，取出并交给网络层。
 
3.2数据链路层协议的三个基本问题：
（1）封装成帧：在一段数据的前后分别添加首部和尾部，构成一个帧。
	1）一个帧的帧长等于帧的数据部分长度加上帧首部和帧尾部。
	2）首部和尾部的作用就是帧定界，同时还包括很多必要的控制信息。
	3）最大传输单元MTU：每种链路层协议规定的所能传送的帧的数据部分的长度上限。
	4）帧定界：SOH表示帧的首部开始，EOT表示帧的结束。
（2）透明传输：所传输的数据中不允许出现和帧界定的控制字符一样的编码。
	1）透明：数据链路层透明地传输数据表示无论什么样的比特组合都能通过这个数据链路层。
	2）数据中出现的控制字符不被解释为控制字符（字节填充）：在SOH或EOT前面插入转义字符ESC。转义字符若出现在数据中，则在其前面插入一个转义字符。
（3）差错检测：
	1）比特差错：传输过程中的比特值出错。
	2）误码率：传输错误的比特占所传输比特的总数。
	3）循环冗余检验CRC：
		1.发送端：在数据M（k个比特）的后面添加供差错检验的n位冗余码（FCS），然后构成一个帧发送出去，一共发送n+k位。
		2.冗余码通过在M后面添加n个0，得到的（k+n）位数除以收发双方商定的（n+1）位除数P，得出的商是Q，而余数是R（帧检验序列FCS：冗余码）
 
[1]与运算：与十进制的乘法效果相同。
[2]异或运算：减运算，相同为0，不同为1。
		3.接收端：把收到的每一个帧都除以同样的除数P，然后检查得到的余数R，若余数为0，则没有差错，若余数不等于0，则该帧有差错，就丢弃。
	4）无差错接收：通过CRC差错检验技术，大概率认为这些帧在传输过程中没有产生差错，实现了无比特差错的传输。
	5）可靠传输：数据链路层的发送端发送了什么，在接收端就接收了什么。但传输差错包括：
		1.比特差错。
		2.帧丢失，帧重复和帧失序。
	6）不同网络的差错检验：
		1.通信质量好的有线传输线路，数据链路层协议不使用确认和重传机制。
		2.通信质量不好的无线传输线路，数据链路层协议使用确认和重传机制。
3.3点对点协议PPP：用户和ISP进行通信时所使用的数据链路层协议。
（1）组成部分
	1）一个将IP数据报封装到串行链路的方法。
	2）一个用来建立、配置和测试数据链路连接的链路控制协议（LCP）
	3）一套网络控制协议NCP，其中每一个协议支持不同的网络层协议。
（2）PPP协议的帧格式：
	1）各字段的意义：
 
		1.标志字段：F，为0x7E，表示一个帧的开始或结束。
		2.地址字段：A，为0xFF
		3.控制字段：C，为0x03
		4.协议字段：有两个字节，当为0x0021时，表示信息字段是ip数据报，当为0xC021时，表示信息字段是PPP链路控制协议LCP数据，当为0x8021时，表示信息字段是网络层的控制数据。
		5.信息字段
		6.尾部的第一个字段是使用CRC的帧检验序列FCS。
	2）字节填充：当信息字段中出现和标志字段一样的比特时，就需要采取措施。转义字符定义为0x7D，使用字节填充。
	3）零比特填充：在发送端扫描整个信息字段，当发现有5个连续的1时就填入一个0（标志字段的二进制表示是01111110）,接收端可以将这个0去掉。
（3）PPP协议的工作状态：用户PC向ISP发送一系列的链路控制协议LCP分组，以便建立LCP连接，这些分组及其响应选择了将要使用的一些ppp参数。接着进行网络层配置，网络控制协议NCP给新接入的用户PC分配一个临时的IP地址。当用户通信结束，NCP释放网络层连接，回收IP地址，接着LCP释放数据链路层连接，最后释放物理层连接。
3.4 局域网的数据链路层
（1）局域网：网络为一个单位所拥有，且地理范围和站点数量均有限。
（2）共享信道
	1）静态划分信道：频分复用，时分复用，波分复用等
	2）动态媒体接入控制：
	1.随机接入：用户可以随时发送信息，如果有多个用户同时发送信息，必须要解决碰撞问题。
	2.受控接入：用户不能随时发送信息，必须服从一定的控制。
（3）以太网：是一种基带总线局域网，其数据链路层分为逻辑链路控制（LLC）和媒体接入控制（MAC），目前大部分厂商生产的适配器只有MAC协议。
（4）适配器：计算机是通过适配器连接到外界的局域网的。
1）适配器是计算机主板中嵌入的网卡，上面装有处理器（RAM）和存储器（ROM）。
2）适配器和局域网之前的通信是通过电缆和双绞线以串行的方式进行的，和计算机之前的通信是通过主板上的IO总线以并行的范式进行的，因此是适配器实现了数据串行传输和并行传输的转换。
 
3.5 以太网的通信
（1）采用灵活的无连接方式，不必先建立连接就直接发送数据，当有差错帧时，是否需要重传则有高层决定。在同一时间只能允许一台计算机发送数据，否则计算机之间会相互干扰，以太网采用CSMA/CD协议实现随机接入。
（2）以太网发送的数据都是曼切斯特编码，保证了每个码元的正中间出现一次电压转换，而接收端能够利用电压的转换将位同步信号提取出来。
3.6 CSMA/CD协议
（1）多点接入：总线型网络，许多计算机以多点的方式连接在一根总线上。
（2）载波监听：检测信道，不管在发送前和发送中每个站都必须不听地检测信道，等到信号空闲时再发送数据。
（3）碰撞检测：适配器边发送数据，边检测信道上的信号电压的变化情况，判断自己在发送数据时，其他站是否也在发送数据。当多个站在总线上同时发送数据时，总线上的电压会增高，发生了碰撞，适配器应该立即停止发送，等待一段随机时间后再次发送。
（4）信道发送碰撞的情况：
 
	1） 在CSMA/CD中，一个站不能同时进行发送和接收，但必须边发送边监听信道。
	2）争用期：发送数据帧至多通过时间2t（争用期）就可以知道所发送的数据帧是否发生了碰撞。
	3）使用截断二进制指数退避算法确认碰撞后重传的时机，r倍的512比特时间。
	4）为了在发送一个帧的时候就能检测出是否发送碰撞，因此以太网规定了最短帧长64字节，即512Bit，对于小的数据需要加入填充字节。因此凡长度小于64字节的帧都是因为冲突异常终止的无效帧，应当立即放弃。
（5）强化碰撞：当发送数据的站发现发生了碰撞，除了停止发送数据外，还要继续发送32比特或48比特的人为干扰信号，告诉所有的用户现在已经发生了碰撞。
（6）为了使刚刚接收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备，以太网规定帧间最小间隔为9.6us。
3.7 使用集线器的星型拓扑：集线器
（1）使用集线器的以太网逻辑上仍然是一个总线网，各站共享逻辑上的总线，使用CSMA/CD协议。
（2）一个集线器有多个接口，每个接口仅仅简单地转发比特，如果两个接口通知有信号输入（碰撞），那么所有的接口都接收不到正确的帧。
（3）自适应串音回波抵消使较强的信号不对强弱的信号产生干扰。每个比特在转发时还要进行再生整形和重新定时。
3.8 信道利用率：
（1）成功发送一个帧需要占用信道的时间是T0+t
（2）提高信道利用率需要减小参数a=t/T0的值。这说明以太网的连线的长度不能太长（否则t的数值会太大），同时以太网的帧长不能太短（否则T0会太小）
3.9 以太网的MAC层
（1）地址：局域网中的每一台计算机中固化在适配器的ROM中的地址，这每个站的标志符。现在局域网适配器实际上使用的都是6字节MAC地址。MAC地址就是适配器的地址，插入到电脑中，就成了计算机的MAC地址。
1）组织唯一标志符（公司标志符）：注册管理机构RA负责分配地址字段中的前三个字节。世界上凡是生产局域网适配器的厂家都要向注册管理机构RA购买这三个字节的构成的号。
2）扩展标志符：后三个字节，由厂家自行指派，只要保证出产的适配器没有重复地址即可。
3）MAC地址第一个字节的最低位是I/G位：表示单个站地址/组地址。
4）MAC地址第二个字节的第二位是G/L位：表示全球管理/本地管理。
（2）适配器功能：
	1）适配器有过滤功能：每收到一个MAC帧就先用硬件检查MAC帧中的目的地址，如果是发往本站的就收下，否则丢弃。
	2）混合方式：适配器只要听到有帧在以太网上传播就接收下来，实现窃听其他站点的通信，而不中断其他站点的通信。（黑客，监听网上流量）
（3）MAC帧的格式：
 
	1）目的地址字段、源地址字段
2）类型字段：标志上一层使用的是什么协议，以便吧接收到的MAC帧上交给上一层的协议。
3）数据字段：
4）MAC帧前面的8个字节：7个字节的同步码，是接收端的适配器在接收MAC帧时能够调整其时钟频率，与发送端一致。1个字节是帧开始定界符。
3.10扩展的以太网：
（1）在物理层扩展以太网：
	1）使用光纤和光纤调制解调器，扩展主机和集线器之间的距离。
	2）使用多个集线器，连接成覆盖更大范围的多级星型结构的以太网。吞吐量不变，但碰撞域扩大了。
 
（2）在数据链路层扩展以太网
	1）网桥：根据MAC帧的目的地址对接收到的帧进行转发和过滤。能够过滤通信量，增大吞吐量，是以太网各网段成为隔离的碰撞域。
	2）转发表：网桥依靠转发表来转发帧。
（3）透明网桥：只要把网桥接入局域网，不用人工的配置转发表网桥就能工作。
1）自学习算法：若某个站A发出的帧能够从接口x进入网桥，则这个接口出发沿相反方向一定可把一个帧传到A，可以加记录在转发表中。
2）网络拓扑的更新：在转发表中同时记录每个帧到达网桥的最新时间，网桥中的接口管理软件定期扫描，只要超过一定时间的信息都要删除。
（4）源路由网桥：在发送帧时，把详细的路由信息放在帧的首部。
	1）源站以广播的方式向目的站发送一个发现帧作为探测，发现帧将在以太网中沿所有可能的路由传送，在传送过程中，每个发现帧将记录所经过的路由，当这些发现帧达到目的站后，就沿各自的路由返回源站，源站从所有可能的路由中选择一个最佳的路由。以后凡是从这个源站向该目的站发送的帧的首部都必须携带源站所确定的这一路由信息。
（5）多接口网桥——以太网交换机
	1）以太网交换机的每个接口都直接与一个主机或者集线器相连，交换机能够连通很多对接口，使每一对相互通信的主机都能像独占传输媒体那样无碰撞地传输数据。
	2）虚拟VLAN：由一些局域网网段构成的与物理位置无关的逻辑组，每一个VLAN的帧都有一个明确的标识符。
 
 
1.VLAN标记：在以太网的帧格式中插入一个4字节的标识符，指明发送该帧的工作站属于哪个虚拟局域网。
3.11 高速以太网
